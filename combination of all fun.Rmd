---
title: "metagene"
output: html_notebook
version: 
---

```{r}
source("https://bioconductor.org/biocLite.R")
biocLite("GenomicRanges")
biocLite("ggplot2")
biocLite("rtracklayer")
library("rtracklayer")
library("GenomicRanges")
library("ggplot2")
```

Constructing genomic intervals of interest
```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/geneslist.R", local=T)
promoter_region <- regionlist(plus=1000, minus=500, pos_strand="//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/pos_strand_annotations.bed", neg_strand="//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/neg_strand_annotations.bed")

```



Data import
```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/metagene_filelist.R", local=T)
filesbw <- filelist("//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/cerevisiae_dataForRosa", "churchman")
``` 


Make a matrix with the bins for every gene
```{r}
  source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/bin_genelist.R")
 listwv <- bin_matrix(promoter_region, binsize=5)
 bin_matrix <- listwv$bin_matrix
 bin_grange <- listwv$bin_grange
 numberbin <- listwv$numberbin
 
```

CountOverlap bit
```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/countoverlap_fun.R", local=T)
binned_matrix <- overlapcount(bin_grange, filesbw, bin_matrix)

###Reverse rownames of negative strands: WORKS ONLY AS LONG AS genes_minus is first half, otherwise you have to change this bit
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/revneg_fun.R", local=T)
binned_matrix <- revneg(test_binned_matrix2, bin_matrix)

binned_matrix <- cbind(test_binned_matrix[,1], binned_matrix)


```



sum over bins

```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/metatable_fun.R", local=T)

metagene_table <- metatable(numberbin, filesbw, binned_matrix)

binned_matrix <- binned_matrix[,2:13]

source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/combstrand_fun.R")
combined <- comstrand(metagene_table)



############ what has happened to genes that are overlapping. Multiple transcription start sites.
############ data is not normalised yet?
```


```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/graph_samples_fun.R")
graph_samples(combined)
```
















```{r}
#f <- function(x) length( intersect(seq(x[1],x[2],1), seq(x[3],x[4],1)) )

#a <- apply(X,1,f)






```




