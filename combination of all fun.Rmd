---
title: "metagene"
output: html_notebook
version: 
---

```{r}
source("https://bioconductor.org/biocLite.R")
biocLite("GenomicRanges")
biocLite("ggplot2")
biocLite("rtracklayer")
library("rtracklayer")
library("GenomicRanges")
library("ggplot2")
```

Constructing genomic intervals of interest
```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/geneslist_FUN.R")
res <- regionlist(plus=1000, minus=500, pos_strand="//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/pos_strand_annotations.bed", neg_strand="//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/neg_strand_annotations.bed")


promoter_region <- res$promoter_region
genes_plus <- res$genes_plus
genes_minus <- res$genes_minus

source("/home/immd0754/Documents/R_things/General R scripts/metagene/overlap1_FUN.R")
promoter_region <- overlap1(promoter_region, genes_plus, genes_minus, minus=500)

```



Data import
```{r}
source("/home/immd0754/Documents/R_things/General R scripts/metagene/filelist_FUN.R", local=T)
filesbw <- filelist("//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/cerevisiae_dataForRosa", "churchman", MinPlus_ann=c("plus|posstrand|unipos","minus|negstrand|unimin"))
``` 


Make a matrix with the bins for every gene
```{r}
  source("/home/immd0754/Documents/R_things/General R scripts/metagene/bin_genelist_FUN.R")
 listwv <- bin_matrix(promoter_region, binsize=5)
 bin_matrix <- listwv$bin_matrix
 bin_grange <- listwv$bin_grange
 numberbin <- listwv$numberbin

 
```

CountOverlap bit
```{r}
source("/home/immd0754/Documents/R_things/General R scripts/metagene/countoverlap_fun.R", local=T)
binned_matrix <- overlapcount(bin_grange, filesbw, bin_matrix, MinPlus_ann=c("plus|posstrand|unipos","minus|negstrand|unimin"))

###Reverse rownames of negative strands: WORKS ONLY AS LONG AS genes_minus is first half, otherwise you have to change this bit
source("/home/immd0754/Documents/R_things/General R scripts/metagene/revneg_FUN.R", local=T)
stri_bins <- revneg(bin_matrix)



```

```{r}
bin_test <- binned_matrix[,1]
overview_test <- overview[1:2297,,1] # only minus strand genes
overview_test2 <- melt(overview_test)
overview_test3 <- cbind(overview_test2$value, rep(1:689100, each=5))
overview_test4 <- as.vector(by(overview_test3$v1, INDICES = overview_test3$v2, sum))
overview_test <- round(overview_test4)


head(overview_test)
```
```{r}
head(bin_test)

```
```{r}
as.data.frame(bwfile)
```

```{r}
head(bin_matrix)
```



sum over bins

```{r}
source("/home/immd0754/Documents/R_things/General R scripts/metagene/normalisiation_FUN.R")
binned_matrix <- normalisation(binned_matrix,numberbin)

source("/home/immd0754/Documents/R_things/General R scripts/metagene/bin_sum_withapply_FUN.R")
metagene_table <- bin_sum(binned_matrix, stri_bins)

source("/home/immd0754/Documents/R_things/General R scripts/metagene/combstrand_fun.R")
combined <- comstrand(metagene_table)



############ what has happened to genes that are overlapping. Multiple transcription start sites.
############ data is not normalised yet?
```


```{r}
source("/home/immd0754/Documents/R_things/General R scripts/metagene/graph_samples_fun.R")
graph_samples(combined, plus=1000, minus=500, numberbin, name="booth")
```
















```{r}
#f <- function(x) length( intersect(seq(x[1],x[2],1), seq(x[3],x[4],1)) )

#a <- apply(X,1,f)






```




