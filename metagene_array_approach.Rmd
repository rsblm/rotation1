---
title: "metagene"
output: html_notebook
version: 
---

```{r}
source("https://bioconductor.org/biocLite.R")
biocLite("GenomicRanges")
biocLite("ggplot2")
biocLite("rtracklayer")
library("rtracklayer")
library("GenomicRanges")
library("ggplot2")
```

Constructing genomic intervals of interest
```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/geneslist_FUN.R")
res <- regionlist(plus=1000, minus=500, pos_strand="//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/pos_strand_annotations.bed", neg_strand="//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/neg_strand_annotations.bed")


promoter_region <- res$promoter_region
genes_plus <- res$genes_plus
genes_minus <- res$genes_minus

source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/overlap1_FUN.R")
promoter_region <- overlap1(promoter_region, genes_plus, genes_minus, minus=500)

```



Data import
```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/metagene_filelist_FUN.R", local=T)
filesbw <- filelist("//biochstore4.bioch.ox.ac.uk/Mellor/Rosa/cerevisiae_dataForRosa", "churchman", MinPlus_ann=c("plus|posstrand|unipos","minus|negstrand|unimin"))
``` 


Make the array
```{r}
test <- array(data=NA, dim=c(nrow(promoter_region), length(filesbw), plus+minus), dimnames= list(promoter_region$V4, names(filesbw)))

s <- (promoter_region$V2[["YAL032C"]]:(promoter_region$V3[["YAL032C"]]-1))
## I want to define s by gene_name(so we can link it to the array or something), so one thing that might help is rownames(promoter_region) <- promoter_region$V4 and another thing is we need to drop levels of genes(somehow with subsetting previously(too short genes, overlapping etc) this hasn't happened yet) for this droplevels(promoter_region$V4). Don't know if that drop levels is at all relevant. 

b <- as.data.frame(test_bw)
b2 <- b[(b$seqnames=="chrI"),] # specific chromosome
b3 <- b2[b2$start>min(s),]
b3 <- b3[b3$start<max(s),]

c <- vector("numeric", length(s)) # fill this at positiono f b3$start with value score

for (i in 1:nrow(b3)) {
  b <- (b3$start[[i]]-min(s))
  c[[b]] <- b3$score[[i]]
}
### This for loop seems to do the trick but maybe it's a bit omslachtig nog... Vooral met het eerst creeren van s.. alle loss eindjes moeten nog samen, dit moet nu in de array op de goede plaats



promoter_regionPlus <- genes_plus[(genes_plus$V3-genes_plus$V2)>1000,]

  source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/bin_genelist_FUN.R")
 listwv <- bin_matrix(promoter_region, binsize=5)
 bin_matrix <- listwv$bin_matrix
 bin_grange <- listwv$bin_grange
 numberbin <- listwv$numberbin

 
```

CountOverlap bit
```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/countoverlap_fun.R", local=T)
binned_matrix <- overlapcount(bin_grange, filesbw, bin_matrix, MinPlus_ann=c("plus|posstrand|unipos","minus|negstrand|unimin"))

###Reverse rownames of negative strands: WORKS ONLY AS LONG AS genes_minus is first half, otherwise you have to change this bit
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/revneg_fun.R", local=T)
stri_bins <- revneg(bin_matrix)



```



sum over bins

```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/normalisiation_FUN.R")
binned_matrix <- normalisation(binned_matrix,numberbin)

source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/bin_sum_withapply_FUN.R")
metagene_table <- bin_sum(binned_matrix, stri_bins)

source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/combstrand_fun.R")
combined <- comstrand(metagene_table)



############ what has happened to genes that are overlapping. Multiple transcription start sites.
############ data is not normalised yet?
```


```{r}
source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/graph_samples_fun.R")
graph_samples(combined, plus=1000, minus=500, numberbin, name="booth")
```
















```{r}
#f <- function(x) length( intersect(seq(x[1],x[2],1), seq(x[3],x[4],1)) )

#a <- apply(X,1,f)






```




