---
title: "metagene"
output: html_notebook
version: 
---

```{r}
source("https://bioconductor.org/biocLite.R")
biocLite("GenomicRanges")
biocLite("ggplot2")
biocLite("rtracklayer")
library("rtracklayer")
library("GenomicRanges")
library("ggplot2")
```

Constructing genomic intervals of interest
```{r}
source("/home/immd0754/Documents/R_things/General R scripts/metagene/regionlist_length_yeast_FUN.R")
res <- regionlist(plus=1000, minus=500, pos_strand="/home/immd0754/S_MELLOR/Rosa/pos_strand_annotations.bed", neg_strand="/home/immd0754/S_MELLOR/Rosa/neg_strand_annotations.bed")


promoter_region <- res$promoter_region
genes_plus <- res$genes_plus
genes_minus <- res$genes_minus


## Don't use at it is because it makes the promoter region list longer??
#source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/overlap1_FUN.R")
#promoter_region <- overlap1(promoter_region, genes_plus, genes_minus, minus=500)

```



Data import
```{r}
source("/home/immd0754/Documents/R_things/General R scripts/metagene/filelist_FUN.R")
filesbw <- filelist("/home/immd0754/S_MELLOR/Rosa/cerevisiae_dataForRosa", "churchman", MinPlus_ann=c("plus|posstrand|unipos","minus|negstrand|unimin"))
``` 






```{r}
source("/home/immd0754/Documents/R_things/General R scripts/metagene/bw_to_countmatrix_FUN.R")
overview_sum <- bw_to_countmatrix(filesbw, genes_minus, genes_plus, plus, minus, MinPlus_ann=c("plus|posstrand|unipos","minus|negstrand|unimin"))

overview <- overview_sum$overview_exl
sum_exl_read_dens <- overview_sum$sum_exl_read_dens


###Reverse rows of negative strand, WORKS ONLY AS LONG AS genes_minus is first half, otherwise you have to change this bit
source("/home/immd0754/Documents/R_things/General R scripts/metagene/rev_neg_array_FUN.R")
overview_rev <- rev_neg_array(overview, genes_minus, sum_exl_read_dens)

## Normalisation
source("/home/immd0754/Documents/R_things/General R scripts/metagene/normalise_array_FUN.R")
overview_rev_norm <- normalise_array(overview_rev, filesbw)

#source("C:/Users/immd0754/Documents/R_things/General R scripts/metagene/bin_sum_withapply_FUN.R")
m <- apply(overview_rev_norm, c(2,3), mean) # more or less same as below
m2 <- apply(overview_rev_norm, 3, colSums) # more or less same as above


############ what has happened to genes that are overlapping. Multiple transcription start sites.
m2 <- cbind(m, rep(1:(nrow(m)/3), each=3))
m <- cbind(as.vector(by(m2[,1], INDICES=m2[,3], sum)), as.vector(by(m2[,2], INDICES=m2[,3], sum)))

graph_samples(as.data.frame(m), plus=1000, minus=500, name="churchman", filesbw)


```


```{r}
source("/home/immd0754/Documents/R_things/General R scripts/metagene/graph_samples_FUN.R")
graph_samples(as.data.frame(t(overview_rev[110:115,,2])), plus=1000, minus=500, name="churchman", filesbw)
graph_samples(as.data.frame(t(overview_rev_norm[110:115,,2])), plus=1000, minus=500, name="churchman_norm", filesbw)
graph_samples(as.data.frame(t(overview_rev[10:15,,2])), plus=1000, minus=500, name="churchman_norm", filesbw)
graph_samples(as.data.frame(m), plus=1000, minus=500, name="churchman", filesbw)

# to look at a few genes: t(overview[4010:4015,,2])
```
















```{r}
#f <- function(x) length( intersect(seq(x[1],x[2],1), seq(x[3],x[4],1)) )

#a <- apply(X,1,f)






```




